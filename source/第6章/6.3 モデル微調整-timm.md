# 6.3 モデル微調整 - timm
`torchvision.models` 以外にも、Ross Wightman 氏による `timm` という事前学習モデル集があります。コンピュータビジョンの SOTA モデルを多数収録し、torchvision の拡張版のように使え、精度の高い実装が多いです。本章では主にこのライブラリのモデル利用に焦点を当てます（データ拡張・最適化器などは参照リンクを参照）。
- Github链接：https://github.com/rwightman/pytorch-image-models
- 官网链接：https://fastai.github.io/timmdocs/
					https://rwightman.github.io/pytorch-image-models/

## 6.3.1 timm のインストール
timm は以下のいずれかで導入できます：
1. pip でインストール
```shell
pip install timm
```
2. ソースからインストール
```shell
git clone https://github.com/rwightman/pytorch-image-models
cd pytorch-image-models && pip install -e .
```

## 6.3.2 事前学習モデルの一覧
1. 提供モデルの一覧
2022/03/27 時点で 592 個の事前学習モデルがあります。`timm.list_models(pretrained=True)` で一覧できます（本章の動作確認は Jupyter で実施）。
```python
import timm
avail_pretrained_models = timm.list_models(pretrained=True)
len(avail_pretrained_models)
```

```shell
592
```
2. 特定シリーズの一覧
シリーズ名で絞り込み可能です（あいまい検索）。例：DenseNet 系列を列挙。
```python
all_densnet_models = timm.list_models("*densenet*")
all_densnet_models
```
リストとして DenseNet 系列のモデルが返ります。
```shell
['densenet121',
 'densenet121d',
 'densenet161',
 'densenet169',
 'densenet201',
 'densenet264',
 'densenet264d_iabn',
 'densenetblur121d',
 'tv_densenet121']
```
3. モデルの設定を確認
モデルの `default_cfg` 属性で入力サイズや前処理などを確認できます：
```python
model = timm.create_model('resnet34',num_classes=10,pretrained=True)
model.default_cfg
```
```python
{'url': 'https://github.com/rwightman/pytorch-image-models/releases/download/v0.1-weights/resnet34-43635321.pth',
 'num_classes': 1000,
 'input_size': (3, 224, 224),
 'pool_size': (7, 7),
 'crop_pct': 0.875,
 'interpolation': 'bilinear',
 'mean': (0.485, 0.456, 0.406),
 'std': (0.229, 0.224, 0.225),
 'first_conv': 'conv1',
 'classifier': 'fc',
 'architecture': 'resnet34'}
```
また、[こちら](https://rwightman.github.io/pytorch-image-models/results/) で精度などの一覧が確認できます。

## 6.3.3 事前学習モデルの利用と改変
利用したいモデルは `timm.create_model()` で作成します。`pretrained=True` で事前学習重みを読み込みます。torchvision と同様に属性やパラメータを確認できます。
```python
import timm
import torch

model = timm.create_model('resnet34',pretrained=True)
x = torch.randn(1,3,224,224)
output = model(x)
output.shape
```

```shell
torch.Size([1, 1000])
```
- 特定層のパラメータ確認（例：最初の畳み込み）
```python
model = timm.create_model('resnet34',pretrained=True)
list(dict(model.named_children())['conv1'].parameters())
```
```python
[Parameter containing:
 tensor([[[[-2.9398e-02, -3.6421e-02, -2.8832e-02,  ..., -1.8349e-02,
            -6.9210e-03,  1.2127e-02],
           [-3.6199e-02, -6.0810e-02, -5.3891e-02,  ..., -4.2744e-02,
            -7.3169e-03, -1.1834e-02],
            ...
           [ 8.4563e-03, -1.7099e-02, -1.2176e-03,  ...,  7.0081e-02,
             2.9756e-02, -4.1400e-03]]]], requires_grad=True)]
            
```
- 分類数の変更（1000 クラス → 10 クラス）
```python
model = timm.create_model('resnet34',num_classes=10,pretrained=True)
x = torch.randn(1,3,224,224)
output = model(x)
output.shape
```
```python
torch.Size([1, 10])
```
- 入力チャネル数の変更（単チャネル画像などに対応）
`in_chans=1` を指定します。
```python
model = timm.create_model('resnet34',num_classes=10,pretrained=True,in_chans=1)
x = torch.randn(1,1,224,224)
output = model(x)
```
## 6.3.4 モデルの保存
timm のモデルは `torch.nn.Module` 派生なので、標準の保存/読み込み API が使えます：
```python
torch.save(model.state_dict(),'./checkpoint/timm_model.pth')
model.load_state_dict(torch.load('./checkpoint/timm_model.pth'))
```

## 参考材料
1. https://www.aiuai.cn/aifarm1967.html
2. https://towardsdatascience.com/getting-started-with-pytorch-image-models-timm-a-practitioners-guide-4e77b4bf9055
3. https://chowdera.com/2022/03/202203170834122729.html
